<template>
  <style>
  .message { background: #efefef; display: none }
  :host([offline]) .keep { display: none }
  :host([offline]) .message { display: block }
  </style>
  <div id="web-publication-toolbar">
    <button class="keep" onclick="registerServiceWorker()">
      Keep This ðŸ“– (offline)
    </button>
    <div class="message">
      You have kept a copy of this Web Publication.
      <button class="discard">Discard ðŸ“–</button>
    </div>
  </div>
</template>

<!-- for Firefox -->
<style scope="pub-bar">
  pub-bar[offline] .keep{display:none}
  pub-bar[offline] .message{display:block}
</style>

<script>
  // Refers to the "importer", which is index.html
  var thatDoc = document;
  // Refers to the "importee", which is src/hello-world.html
  var thisDoc =  (thatDoc._currentScript || thatDoc.currentScript).ownerDocument;
  // Gets content from <template>
  var template = thisDoc.querySelector('template');

  // This element will be registered to index.html
  // Because `document` here means the one in index.html
  class PubBar extends HTMLElement {
    constructor() {
      super();
      var root = this.attachShadow({mode: 'open'});
      root.appendChild(document.importNode(template.content, true));

      root.addEventListener('click', (ev) => {
        if (ev.target.matches('.discard')) {
          this.unkeepPublication();
        }
      });
    }
    unkeepPublication() {
      // unregister serviceWorker
      navigator.serviceWorker.getRegistration().then((reg) => {
        reg.unregister().then((status) => {
          // remove cache
          window.caches.delete('web-publication').then((status) => {
            // toggle UX state
            this.removeAttribute('offline');
          });
        });
      });
    }
  }

  customElements.define('pub-bar', PubBar);
</script>
